<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MellstroyPlayer — крутой кот</title>

<!-- Favicon (SVG) -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1'%3E%3Cstop offset='0' stop-color='%2334d399'/%3E%3Cstop offset='1' stop-color='%23ef4444'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='12' fill='url(%23g)'/%3E%3Cpath d='M18 36 C24 28, 30 24, 38 22 C46 20, 48 26, 44 30 C40 34, 32 38, 24 38 Z' fill='white' opacity='0.95'/%3E%3C/svg%3E"/>

<style>
:root{
  /* Новая палитра: зелёный + красный акцент */
  --bg:#0a0f0c; --panel:#111614; --glass: rgba(255,255,255,0.04);
  --muted:#b8c3bf; --text:#f3faf5;
  --accent1:#34d399; /* зелёный */
  --accent2:#ef4444; /* красный */
  --accent3:#22c55e; /* дополнительный зелёный */
  --radius:16px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);-webkit-font-smoothing:antialiased}
body{
  background:
    radial-gradient(700px 300px at 8% 8%, rgba(52,211,153,0.06), transparent 18%),
    radial-gradient(700px 420px at 92% 92%, rgba(239,68,68,0.05), transparent 18%),
    linear-gradient(180deg,var(--bg), #0a0e0b 140%);
  padding-bottom:160px;
}

/* Снежинки поверх фона */
#snow{
  position:fixed; inset:0; z-index:0; pointer-events:none;
}

/* Контейнер */
.app{max-width:1000px;margin:0 auto;padding:22px 18px 200px; position:relative; z-index:1}

/* Header */
.header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
.logo{
  width:60px;height:60px;border-radius:14px;
  background:conic-gradient(from 200deg,var(--accent1),var(--accent2),var(--accent3));
  box-shadow:0 14px 40px rgba(52,211,153,0.14), inset 0 0 28px rgba(255,255,255,0.06);
  display:grid;place-items:center;
}
.logo svg{width:32px;height:32px}
.title h1{margin:0;font-size:20px}
.title p{margin:0;font-size:13px;color:var(--muted)}

/* Search + controls row */
.top-row{display:flex;gap:12px;align-items:center;margin-bottom:14px}
.search{flex:1;position:relative}
.search input{
  width:100%;padding:12px 44px 12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,0.06);
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  color:var(--text);outline:none;backdrop-filter: blur(6px);
}
.search .icon{
  position:absolute;right:8px;top:50%;transform:translateY(-50%);width:36px;height:36px;border-radius:10px;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));display:grid;place-items:center;box-shadow:0 8px 20px rgba(52,211,153,0.18);
}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:18px;overflow:auto}
.tab{
  flex:1;min-width:120px;text-align:center;padding:10px;border-radius:12px;font-weight:700;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--muted);cursor:pointer;border:1px solid rgba(255,255,255,0.04)
}
.tab.active{color:var(--text);box-shadow:0 10px 34px rgba(52,211,153,0.08);border:1px solid rgba(52,211,153,0.20)}

/* Playlist rows */
.list{display:flex;flex-direction:column;gap:12px}
.row{
  display:flex;align-items:center;gap:14px;padding:12px;border-radius:14px;position:relative;overflow:hidden;
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.05);backdrop-filter: blur(8px);
}
.row .cover{width:72px;height:72px;border-radius:12px;flex:0 0 72px;overflow:hidden;box-shadow:0 8px 28px rgba(0,0,0,0.45)}
.row img{width:100%;height:100%;object-fit:cover}
.row .meta{flex:1;min-width:0}
.row .meta .name{font-weight:800;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.row .meta .artist{font-size:13px;color:var(--muted);margin-top:6px}
.row .actions{display:flex;gap:8px;align-items:center}

/* Buttons with SVG icons */
.icon-btn, .play-btn{
  display:inline-grid;place-items:center;border:none;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  width:54px;height:54px;border-radius:12px;color:var(--text);cursor:pointer;
  box-shadow:0 10px 28px rgba(0,0,0,0.45), inset 0 0 20px rgba(255,255,255,0.03);
}
.play-btn{width:48px;height:48px;border-radius:50%}

/* Blob accent */
.blob{
  position:absolute;width:160%;height:160%;left:-20%;top:-20%;pointer-events:none;
  background:radial-gradient(closest-side, rgba(52,211,153,0.10), transparent 45%);
  filter: blur(20px);animation:float 8s ease-in-out infinite;z-index:0
}
@keyframes float{0%,100%{transform:translate(0,0)}50%{transform:translate(12px,-12px)}}

/* Compact fixed player bottom */
.player{
  position:fixed;left:12px;right:12px;bottom:18px;padding:12px;border-radius:18px;display:flex;align-items:center;gap:12px;
  background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.06);backdrop-filter:blur(12px);box-shadow:0 30px 80px rgba(2,6,10,0.6);
  z-index:60;
}
.player .thumb{width:72px;height:72px;border-radius:12px;overflow:hidden;flex:0 0 72px}
.player .info{flex:1;min-width:0}
.player .info .t{font-weight:900;font-size:15px}
.player .info .a{font-size:12px;color:var(--muted);margin-top:6px}
.player .controls{display:flex;gap:10px;align-items:center}

/* Progress */
.progress{height:6px;background:rgba(255,255,255,0.06);border-radius:10px;overflow:hidden;margin-top:8px}
.progress .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));box-shadow:0 0 22px rgba(239,68,68,0.24);transition:width .12s linear}

/* Fullscreen modal */
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:22px;background:linear-gradient(180deg, rgba(2,6,8,0.6), rgba(0,0,0,0.85));z-index:120;visibility:hidden;opacity:0;transition:opacity .22s ease, visibility .22s}
.modal.open{visibility:visible;opacity:1}
.modal-card{width:100%;max-width:980px;border-radius:18px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(14px);display:flex;flex-direction:column;gap:12px;align-items:stretch;max-height:92vh;overflow:hidden}
.modal-top{display:flex;gap:16px;align-items:center}
.modal-cover{width:160px;height:160px;border-radius:16px;overflow:hidden;flex:0 0 160px}
.modal-info .title{font-size:20px;font-weight:900}
.canvas-wrap{width:100%;height:300px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));display:flex;align-items:center;justify-content:center}
.big-controls{display:flex;align-items:center;gap:14px;justify-content:center;padding:6px}
.big-btn{width:72px;height:72px;border-radius:50%;border:none;background:radial-gradient(circle at 20% 20%, rgba(52,211,153,0.18), rgba(239,68,68,0.08));display:grid;place-items:center;cursor:pointer}

@media (min-width:900px){
  .app{padding-left:28px;padding-right:28px}
  .modal-card{flex-direction:row}
  .canvas-wrap{height:380px}
  .modal-info{flex:0 0 360px}
}
.hidden{display:none}
</style>
</head>
<body>
<canvas id="snow"></canvas>

<div class="app">
  <header class="header">
    <div class="logo" aria-hidden>
      <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="0" y="0" width="48" height="48" rx="10" fill="url(#g)"/>
        <path d="M14 32c6-8 12-10 20-8-6 8-12 12-20 8z" fill="white" opacity="0.95"/>
        <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#34d399"/><stop offset="1" stop-color="#ef4444"/></linearGradient></defs>
      </svg>
    </div>
    <div class="title">
      <h1>MellstroyPlayer</h1>
      <p>сборник из репозитория — крутой кот</p>
    </div>
  </header>

  <div class="top-row">
    <div class="search">
      <input id="search" placeholder="Поиск треков... (название или автор)" />
      <div class="icon" title="Поиск">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6"><circle cx="11" cy="11" r="6"/><path d="M21 21l-4.3-4.3"/></svg>
      </div>
    </div>
    <button id="shuffleBtn" class="icon-btn" title="Перемешать" aria-label="Перемешать">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 3h6l6 8h6"/><path d="M21 21h-6l-6-8H3"/></svg>
    </button>
  </div>

  <div class="tabs" role="tablist" aria-label="Навигация">
    <div class="tab active" data-target="trending" role="tab">В тренде</div>
    <div class="tab" data-target="all" role="tab">Вся музыка</div>
    <div class="tab" data-target="profile" role="tab">Мой профиль</div>
  </div>

  <section id="trending" class="list" style="display:flex"></section>
  <section id="all" class="list" style="display:none"></section>

  <section id="profile" class="list" style="display:none">
    <div class="row" style="align-items:flex-start">
      <div style="flex:0 0 72px">
        <div style="width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));"></div>
      </div>
      <div class="meta">
        <div class="name">крутой кот</div>
        <div class="artist">Создатель репозитория</div>
        <div class="artist">Треков: <span id="tracks-count">0</span> · Прослушиваний: <span id="plays-count">0</span></div>
      </div>
    </div>
  </section>
</div>

<!-- Компактный плеер -->
<div class="player" id="compactPlayer" aria-hidden="false">
  <div class="thumb" id="compactThumb"><img src="" alt="cover" style="width:100%;height:100%;object-fit:cover"></div>
  <div class="info">
    <div class="t" id="cp-title">Нет трека</div>
    <div class="a" id="cp-artist"></div>
    <div class="progress" id="cp-progress"><div class="bar" id="cp-bar"></div></div>
  </div>

  <div class="controls">
    <button class="icon-btn" id="prevBtn" title="Предыдущий" aria-label="Предыдущий">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M19 18L10 12l9-6v12z"/><path d="M5 6v12"/></svg>
    </button>

    <button class="icon-btn" id="playBtn" title="Пуск" aria-label="Пуск">
      <svg id="playIcon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M7 6v12l10-6L7 6z"/></svg>
      <svg id="pauseIcon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="hidden"><rect x="6" y="6" width="4" height="12"/><rect x="14" y="6" width="4" height="12"/></svg>
    </button>

    <button class="icon-btn" id="nextBtn" title="Следующий" aria-label="Следующий">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M5 6l9 6-9 6V6z"/><path d="M19 6v12"/></svg>
    </button>

    <button class="icon-btn" id="openFullBtn" title="Открыть" aria-label="Открыть">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M21 11V3h-8"/><path d="M3 13v8h8"/></svg>
    </button>
  </div>
</div>

<!-- Полноэкранный плеер -->
<div class="modal" id="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div class="modal-top">
      <div class="modal-cover"><img id="modal-cover" src="" alt="cover" style="width:100%;height:100%;object-fit:cover"></div>
      <div style="flex:1">
        <div class="modal-info">
          <div class="title" id="modal-title"></div>
          <div class="artist" id="modal-artist" style="color:var(--muted);margin-top:6px"></div>
          <div class="artist" style="margin-top:8px;color:var(--muted);font-size:13px">Источник: файлы репозитория</div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button class="icon-btn" id="fs-toggle" aria-label="Пуск/Пауза">
        <svg id="fsPlaySvg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M7 6v12l10-6L7 6z"/></svg>
        <svg id="fsPauseSvg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="hidden"><rect x="6" y="6" width="4" height="12"/><rect x="14" y="6" width="4" height="12"/></svg>
      </button>
      <button class="icon-btn" id="fs-prev" title="Предыдущий" aria-label="Предыдущий">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M19 18L10 12l9-6v12z"/><path d="M5 6v12"/></svg>
      </button>
      <button class="icon-btn" id="fs-next" title="Следующий" aria-label="Следующий">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M5 6l9 6-9 6V6z"/><path d="M19 6v12"/></svg>
      </button>
      <div style="flex:1"></div>
      <button class="icon-btn" id="closeFull" title="Закрыть" aria-label="Закрыть">✕</button>
    </div>

    <div class="canvas-wrap">
      <canvas id="vis" width="1200" height="400" style="width:100%;height:100%"></canvas>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <div style="flex:1" class="progress"><div id="modal-bar" class="bar" style="width:0%"></div></div>
      <div style="width:120px;text-align:right;color:var(--muted)" id="timeLabel">0:00 / 0:00</div>
    </div>
  </div>
</div>

<!-- Audio -->
<audio id="audio" crossorigin="anonymous"></audio>

<script>
/* Плейлист: 4 трека из репозитория рядом с HTML */
const playlist = [
  // 1: Humba.mp3
  { names: ['Humba.mp3','humba.mp3'], title: 'TUNG TUNG TUNG SAHUR', artist: 'GAZAN',
    cover: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRP8N2cSCOjyG5P8yhpGsCSFd6GMuhI2gvVkAdMI-CcCA&s=10' },

  // 2: fonk.mp3
  { names: ['fonk.mp3','Fonk.mp3','FONK.mp3'], title: 'ДАДА НЕТ-НЕТ', artist: 'МЕЛЛСТРОЙ.ГЕЙ',
    cover: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQo2rtKPwsUPQ5e1C_PPXV7tCwaleaDE7nrQsoYi2qA2A&s=10' },

  // 3: Worm.mp3
  { names: ['Worm.mp3','worm.mp3','WORM.mp3'], title: 'G19 - WormGanger, TRAKOV', artist: 'ПАН ШАРИIЙ',
    cover: 'https://m.media-amazon.com/images/I/51aZ4HL44yL._SX354_SY354_BL0_QL100__UXNaN_FMjpg_QL85_.jpg' },

  // 4: pesnya.mp3
  { names: ['pesnya.mp3','PESNYA.mp3','Pesnya.mp3'], title: 'ч і друн', artist: 'Barabanov, koji',
    cover: 'https://files.catbox.moe/d93uui.jpeg' }
];

let idx = 0;
let plays = 0;

/* DOM refs */
const audio = document.getElementById('audio');
const trendingSection = document.getElementById('trending');
const allSection = document.getElementById('all');
const searchEl = document.getElementById('search');
const shuffleBtn = document.getElementById('shuffleBtn');
const cpTitleDom = document.querySelector('.player .t');
const cpArtistDom = document.querySelector('.player .a');
const cpBar = document.getElementById('cp-bar');
const cpProgress = document.getElementById('cp-progress');
const playBtn = document.getElementById('playBtn');
const playIcon = document.getElementById('playIcon');
const pauseIcon = document.getElementById('pauseIcon');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const openFullBtn = document.getElementById('openFullBtn');
const compactThumb = document.querySelector('#compactThumb img');
const modal = document.getElementById('modal');
const modalCover = document.getElementById('modal-cover');
const modalTitle = document.getElementById('modal-title');
const modalArtist = document.getElementById('modal-artist');
const closeFullBtn = document.getElementById('closeFull');
const fsToggle = document.getElementById('fs-toggle');
const fsPlaySvg = document.getElementById('fsPlaySvg');
const fsPauseSvg = document.getElementById('fsPauseSvg');
const fsPrev = document.getElementById('fs-prev');
const fsNext = document.getElementById('fs-next');
const modalBar = document.getElementById('modal-bar');
const timeLabel = document.getElementById('timeLabel');
const playsCountEl = document.getElementById('plays-count');
const tracksCountEl = document.getElementById('tracks-count');
const visCanvas = document.getElementById('vis');
tracksCountEl.textContent = playlist.length;

/* Безопасный текст */
function safeText(s){ return String(s||''); }

/* Поиск валидного имени файла: HEAD → partial GET → fallback */
async function findAvailableName(names){
  for(const n of names){
    try{
      const res = await fetch(n, {method:'HEAD'});
      if(res && (res.status >= 200 && res.status < 400)) return n;
    }catch(e){
      try{
        const res2 = await fetch(n, {method:'GET', headers:{Range:'bytes=0-0'}});
        if(res2 && (res2.status >= 200 && res2.status < 400)) return n;
      }catch(e2){}
    }
  }
  return names[0];
}

/* Построить строку плейлиста */
function buildRow(track, i){
  const div = document.createElement('div');
  div.className = 'row';
  div.tabIndex = 0;
  div.innerHTML = `
    <div class="blob"></div>
    <div class="cover"><img src="${track.cover}" alt="cover"></div>
    <div class="meta">
      <div class="name">${safeText(track.title)}</div>
      <div class="artist">${safeText(track.artist)}</div>
    </div>
    <div class="actions">
      <button class="play-btn" aria-label="Пуск">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M7 6v12l10-6L7 6z"/></svg>
      </button>
    </div>
  `;
  div.addEventListener('click', ()=> openAndPlay(i));
  div.querySelector('.play-btn').addEventListener('click', (ev)=>{ ev.stopPropagation(); playIndex(i); });
  div.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') openAndPlay(i); });
  return div;
}

/* Заполнить разделы */
function populateLists(list = playlist){
  trendingSection.innerHTML = '';
  allSection.innerHTML = '';
  list.forEach((tr, i) => {
    trendingSection.appendChild(buildRow(tr, i));
    allSection.appendChild(buildRow(tr, i));
  });
}
populateLists();

/* Загрузка трека по индексу */
async function loadTrack(i){
  idx = i;
  const entry = playlist[i];
  const file = await findAvailableName(entry.names);
  audio.src = file;
  audio.load();
  updateUI(i);
  updateProgress(0,0);
}

/* Обновление UI */
function updateUI(i){
  const t = playlist[i];
  if(cpTitleDom) cpTitleDom.textContent = t.title;
  if(cpArtistDom) cpArtistDom.textContent = t.artist;
  if(compactThumb) compactThumb.src = t.cover;
  modalCover.src = t.cover;
  modalTitle.textContent = t.title;
  modalArtist.textContent = t.artist;
}

/* Управление воспроизведением */
async function playIndex(i){ await loadTrack(i); try{ await audio.play(); }catch(e){} }
async function openAndPlay(i){ await loadTrack(i); openFull(); try{ await audio.play(); }catch(e){} }
function nextTrack(){ idx = (idx + 1) % playlist.length; loadTrack(idx); audio.play().catch(()=>{}); }
function prevTrack(){ idx = (idx - 1 + playlist.length) % playlist.length; loadTrack(idx); audio.play().catch(()=>{}); }
function togglePlay(){
  if(!audio.src){ loadTrack(idx).then(()=>audio.play().catch(()=>{})); return; }
  if(audio.paused){ audio.play().catch(()=>{}); } else { audio.pause(); }
}
function seekRelative(sec){ audio.currentTime = Math.max(0, Math.min(audio.duration || 0, audio.currentTime + sec)); }

/* Перемешивание */
shuffleBtn.addEventListener('click', ()=>{
  for(let i = playlist.length -1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
  }
  populateLists();
});

/* Поиск */
searchEl.addEventListener('input', ()=>{
  const q = searchEl.value.toLowerCase().trim();
  const filtered = playlist.filter(t => t.title.toLowerCase().includes(q) || t.artist.toLowerCase().includes(q));
  populateLists(filtered.length ? filtered : playlist);
});

/* Прогресс и события audio */
function updateProgress(current, duration){
  const pct = duration ? (current/duration)*100 : 0;
  cpBar.style.width = pct + '%';
  modalBar.style.width = pct + '%';
  timeLabel.textContent = formatTime(current) + ' / ' + formatTime(duration);
}
function formatTime(s){ if(!isFinite(s)) return '0:00'; const m=Math.floor(s/60); const sec=Math.floor(s%60); return m+':'+String(sec).padStart(2,'0'); }

audio.addEventListener('play', ()=>{
  playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden');
  fsPlaySvg.classList.add('hidden'); fsPauseSvg.classList.remove('hidden');
  plays++; if(playsCountEl) playsCountEl.textContent = String(plays);
});
audio.addEventListener('pause', ()=>{
  playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden');
  fsPlaySvg.classList.remove('hidden'); fsPauseSvg.classList.add('hidden');
});
audio.addEventListener('timeupdate', ()=> updateProgress(audio.currentTime, audio.duration || 0));
audio.addEventListener('ended', ()=> { nextTrack(); audio.play().catch(()=>{}); });

cpProgress.addEventListener('pointerdown', (e)=>{
  const rect = cpProgress.getBoundingClientRect();
  const x = (e.clientX - rect.left); const pct = x/rect.width;
  if(audio.duration) audio.currentTime = pct * audio.duration;
});

/* Вкладки */
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('section').forEach(s => s.style.display = 'none');
    const target = document.getElementById(t.dataset.target);
    if(target) target.style.display = 'flex';
  });
});

/* Модал / визуализация */
function openFull(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); startVis(); }
function closeFull(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); stopVis(); }
openFullBtn.addEventListener('click', openFull);
closeFullBtn.addEventListener('click', closeFull);
prevBtn.addEventListener('click', prevTrack);
nextBtn.addEventListener('click', nextTrack);
playBtn.addEventListener('click', togglePlay);
fsToggle.addEventListener('click', togglePlay);
fsPrev.addEventListener('click', prevTrack);
fsNext.addEventListener('click', nextTrack);
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeFull(); });

/* Double-click cover */
document.addEventListener('dblclick', (e)=>{ if(e.target.closest('.cover')) openFull(); });

/* Визуализация: WebAudio */
let audioCtx, analyser, sourceNode, dataArray, rafId;
const canvas = visCanvas; const ctx = canvas.getContext('2d');

function startVis(){
  if(rafId) return;
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }
  try{
    if(!sourceNode){
      sourceNode = audioCtx.createMediaElementSource(audio);
      sourceNode.connect(analyser);
      analyser.connect(audioCtx.destination);
    }
  }catch(e){}
  if(audioCtx.state === 'suspended'){ audioCtx.resume().catch(()=>{}); }
  drawVis();
}
function stopVis(){ if(rafId) cancelAnimationFrame(rafId); rafId = null; ctx.clearRect(0,0,canvas.width,canvas.height); }

function drawVis(){
  rafId = requestAnimationFrame(drawVis);
  analyser.getByteFrequencyData(dataArray);

  const dpr = window.devicePixelRatio || 1;
  const w = canvas.clientWidth * dpr, h = canvas.clientHeight * dpr;
  if(canvas.width !== w || canvas.height !== h){ canvas.width = w; canvas.height = h; }
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const grad = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
  grad.addColorStop(0, 'rgba(52,211,153,0.08)');
  grad.addColorStop(0.6, 'rgba(239,68,68,0.06)');
  ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.lineWidth = 2 * dpr; ctx.strokeStyle = 'rgba(255,255,255,0.95)'; ctx.beginPath();
  const step = Math.max(1, Math.floor(dataArray.length / (canvas.width / (4*dpr))));
  let x = 0;
  for(let i=0;i<dataArray.length;i+=step){
    const v = dataArray[i] / 255.0;
    const y = canvas.height - (v * canvas.height * 0.78) - (Math.sin(i/5 + performance.now()/500)*8*dpr);
    if(x===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    x += (canvas.width / Math.ceil(dataArray.length/step));
  }
  ctx.stroke();

  const peak = Math.max(...dataArray);
  if(peak > 160){
    ctx.fillStyle = 'rgba(239,68,68,0.08)';
    ctx.beginPath();
    ctx.ellipse(canvas.width*0.5, canvas.height*0.35, peak*1.2*dpr, peak*0.7*dpr, 0, 0, Math.PI*2);
    ctx.fill();
  }
}

/* Снег: лёгкая анимация снежинок через canvas */
(function snow(){
  const c = document.getElementById('snow');
  const sctx = c.getContext('2d');
  let flakes = [];
  const dpr = window.devicePixelRatio || 1;
  function resize(){
    c.width = innerWidth * dpr; c.height = innerHeight * dpr;
  }
  resize(); window.addEventListener('resize', resize);

  function makeFlake(){
    return {
      x: Math.random() * c.width,
      y: Math.random() * -c.height,
      r: (Math.random()*1.2 + 0.6) * dpr,
      v: Math.random()*0.6 + 0.3,
      drift: (Math.random()*0.4 - 0.2)
    };
  }
  for(let i=0;i<120;i++) flakes.push(makeFlake());

  function draw(){
    sctx.clearRect(0,0,c.width,c.height);
    sctx.fillStyle = 'rgba(255,255,255,0.8)';
    for(const f of flakes){
      sctx.beginPath();
      sctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
      sctx.fill();
      f.y += f.v * dpr;
      f.x += Math.sin(f.y/80) * f.drift * dpr;
      if(f.y > c.height + 4*dpr) { f.x = Math.random()*c.width; f.y = -10*dpr; f.r = (Math.random()*1.2 + 0.6)*dpr; f.v = Math.random()*0.6+0.3; f.drift = (Math.random()*0.4 - 0.2); }
    }
    requestAnimationFrame(draw);
  }
  draw();
})();

/* Инициализация */
updateUI(0);

/* Обработчики */
openFullBtn.addEventListener('click', openFull);
closeFullBtn.addEventListener('click', closeFull);
prevBtn.addEventListener('click', prevTrack);
nextBtn.addEventListener('click', nextTrack);
playBtn.addEventListener('click', togglePlay);
fsToggle.addEventListener('click', togglePlay);
fsPrev.addEventListener('click', prevTrack);
fsNext.addEventListener('click', nextTrack);
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeFull(); });

/* Прогрев первого трека (необязательно) */
findAvailableName(playlist[0].names).then(()=>{});
</script>
</body>
</html>
